<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MuDoc - Hata Korumalı Başlatma</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* CSS for the glow/illumination effect */
        .neon-glow {
            text-shadow: 0 0 5px #f97316, 0 0 10px #f97316, 0 0 20px #ea580c;
        }
        .card-glow {
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.4), 0 0 20px rgba(249, 115, 22, 0.2);
        }
        .btn-glow {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.6);
        }
        .btn-glow:hover {
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.9), 0 0 30px rgba(249, 115, 22, 0.5);
            transform: translateY(-1px);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
        }
        /* Scrollbar styling for a dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #f97316;
            border-radius: 4px;
        }
        .container-item.active {
            background-color: #f97316;
            color: #1f2937;
            font-weight: 600;
        }
        .container-item.active .text-gray-400 {
            color: #1f2937 !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <!-- Loading Screen (Displayed until Firebase Auth is ready and data is loaded) -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-500"></div>
        <p class="mt-4 text-orange-400 text-lg font-semibold">Güvenli Giriş Yapılıyor...</p>
        <p class="mt-2 text-gray-500 text-sm">Verileriniz sunucudan yükleniyor.</p>
    </div>

    <!-- Main Content Grid -->
    <div id="main-app-content" class="max-w-7xl mx-auto hidden">
        <!-- Header -->
        <header class="text-center mb-6 border-b border-gray-700 pb-4 flex justify-between items-center">
            <div class="flex-1 text-left">
                <button id="auth-button" onclick="openAuthModal()" 
                        class="bg-gray-700 hover:bg-gray-600 text-gray-200 py-2 px-4 rounded-lg text-sm btn-glow flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    <span id="auth-status-text">Hesap</span>
                </button>
            </div>
            <div class="flex-2 text-center">
                <h1 class="text-5xl sm:text-6xl font-extrabold text-orange-400 neon-glow">MuDoc V4</h1>
                <p class="mt-1 text-lg text-gray-400">
                    Kullanıcı ID: <span id="user-id-display" class="font-mono text-xs bg-gray-700 rounded-md px-2 py-0.5 ml-1">Yükleniyor...</span>
                </p>
            </div>
            <div class="flex-1"></div> <!-- Spacer -->
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

            <!-- 1. Konumlar Listesi (Containers) -->
            <div class="lg:col-span-1 p-6 bg-gray-800 rounded-xl card-glow h-fit">
                <h2 class="text-3xl font-bold mb-4 text-orange-400">Konumlar</h2>

                <!-- Add New Container Form -->
                <div class="space-y-3 mb-6 p-3 bg-gray-900 rounded-lg border border-orange-500/30">
                    <input type="text" id="new-container-name" placeholder="Yeni Konum Adı (örn: Ofis)"
                           class="w-full p-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500/50 placeholder-gray-500 text-sm">
                    <input type="password" id="new-container-password" placeholder="Şifre (Zorunlu Değil)"
                           class="w-full p-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500/50 placeholder-gray-500 text-sm">
                    <button onclick="createContainer()"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg btn-glow text-sm">
                        Konum Oluştur
                    </button>
                </div>

                <!-- Containers List -->
                <div id="containers-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Container items will be injected here -->
                    <p class="text-center py-4 text-gray-500 text-sm" id="no-containers-message">
                        Henüz hiç konum oluşturulmadı.
                    </p>
                </div>
            </div>

            <!-- 2. Konum İçeriği (Container Content) -->
            <div class="lg:col-span-3 p-6 bg-gray-800 rounded-xl card-glow min-h-[600px]">
                <div id="content-area">
                    <h2 class="text-3xl font-bold mb-4 text-orange-400">İçerik Görüntüleyici</h2>
                    <div id="welcome-message" class="text-center py-20 text-gray-500 text-lg">
                        Lütfen soldan bir konum seçin veya yeni bir konum oluşturun.
                    </div>
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- --- Modals --- -->

    <!-- Message Box/Modal (General purpose) -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl card-glow max-w-sm w-full border border-orange-500">
            <h3 class="text-xl font-bold text-orange-400 mb-4" id="message-title">Bilgi</h3>
            <p class="text-gray-300 mb-6" id="message-content">Mesaj içeriği.</p>
            <button onclick="closeMessageBox()"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg btn-glow">
                Kapat
            </button>
        </div>
    </div>

    <!-- Confirmation Modal (for delete actions) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl card-glow max-w-sm w-full border border-red-500">
            <h3 class="text-xl font-bold text-red-400 mb-4" id="confirm-title">Onay Gerekli</h3>
            <p class="text-gray-300 mb-6" id="confirm-content">Emin misiniz?</p>
            <div class="flex space-x-4">
                <button onclick="commitConfirmation(true)"
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg btn-glow">
                    Evet, Onaylıyorum
                </button>
                <button onclick="commitConfirmation(false)"
                        class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">
                    İptal
                </button>
            </div>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl card-glow max-w-sm w-full border border-orange-500">
            <h3 class="text-xl font-bold text-orange-400 mb-4">Konum Kilitli</h3>
            <p class="text-gray-300 mb-4" id="password-modal-name"></p>
            <input type="password" id="password-modal-input" placeholder="Şifreyi Girin"
                   class="w-full p-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500/50 placeholder-gray-500 mb-4">
            <button onclick="unlockContainerAttempt()"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg btn-glow">
                Kilidi Aç
            </button>
            <button onclick="closePasswordModal()"
                    class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">
                İptal
            </button>
        </div>
    </div>
    
    <!-- Auth Modal (Sign-In/Sign-Up) -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-8 rounded-xl card-glow max-w-md w-full border border-green-500">
            <h3 class="text-2xl font-bold text-green-400 mb-4">Kullanıcı Hesabı</h3>
            <div id="auth-content">
                <!-- Dynamic content based on auth state will be placed here -->
            </div>
            <button onclick="closeAuthModal()"
                    class="w-full mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">
                Kapat
            </button>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="rename-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl card-glow max-w-sm w-full border border-orange-500">
            <h3 class="text-xl font-bold text-orange-400 mb-4">Konumu Yeniden Adlandır</h3>
            <input type="text" id="rename-modal-input" placeholder="Yeni Ad"
                   class="w-full p-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500/50 placeholder-gray-500 mb-4">
            <button onclick="commitRename()"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg btn-glow">
                Kaydet
            </button>
            <button onclick="closeRenameModal()"
                    class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">
                İptal
            </button>
        </div>
    </div>


    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let isAuthReady = false;
        let isAnonymous = false;

        // --- Application State ---
        let containers = [];
        let activeContainerId = null;
        let containerToRenameId = null; 
        let confirmationResolver = null;

        // --- Utility Functions (MessageBox, Confirmation, ID generation are the same) ---

        window.showMessageBox = function(title, content) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
        }

        window.closeMessageBox = function() {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }

        window.showConfirmationBox = function(title, content) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-content').textContent = content;
            document.getElementById('confirmation-modal').classList.remove('hidden');
            document.getElementById('confirmation-modal').classList.add('flex');

            return new Promise(resolve => {
                confirmationResolver = resolve;
            });
        }

        window.commitConfirmation = function(result) {
            document.getElementById('confirmation-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.remove('flex');
            if (confirmationResolver) {
                confirmationResolver(result);
                confirmationResolver = null;
            }
        }

        function generateId() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function getContainerById(id) {
            return containers.find(c => c.id === id);
        }

        // --- Firebase/Firestore Logic ---

        function getUserContainersCollection() {
            // Path: /artifacts/{appId}/users/{userId}/muDocContainers
            if (!db || !userId) return null;
            return collection(db, 'artifacts', appId, 'users', userId, 'muDocContainers');
        }

        // Tracks whether the listener has been setup to prevent multiple calls
        let isListenerSetup = false;
        let unsubscribeContainers = null;

        function setupContainerListener() {
            if (isListenerSetup && unsubscribeContainers) {
                unsubscribeContainers(); // Stop the old listener if exists
            }

            const containersCol = getUserContainersCollection();
            if (!containersCol) {
                // If user logs out, we clear the data and show no containers.
                containers = [];
                activeContainerId = null;
                renderContainersList();
                document.getElementById('content-area').innerHTML = document.getElementById('welcome-message').outerHTML;
                isListenerSetup = false;
                return;
            }

            // Start new listener
            unsubscribeContainers = onSnapshot(containersCol, (snapshot) => {
                const newContainers = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    newContainers.push({
                        id: doc.id,
                        ...data,
                        content: data.content || [],
                        unlocked: data.password ? false : true 
                    });
                });

                newContainers.sort((a, b) => a.name.localeCompare(b.name, 'tr', { sensitivity: 'base' }));

                containers = newContainers;
                renderContainersList();

                if (activeContainerId) {
                    selectContainer(activeContainerId, false);
                }

            }, (error) => {
                console.error("Firestore Dinleme Hatası:", error);
                // If permission denied, ensure UI reflects the issue.
                if (error.code === 'permission-denied') {
                    showMessageBox("Hata", "Veritabanı erişim hatası. Giriş yapmanız gerekebilir.");
                } else {
                    showMessageBox("Hata", "Veritabanı bağlantısı kesildi veya bir hata oluştu.");
                }
            });
            isListenerSetup = true;
        }

        async function updateContainer(container) {
            if (!isAuthReady || !db || !container.id) {
                showMessageBox("Hata", "Kimlik doğrulama veya veritabanı hazır değil.");
                return;
            }

            const { unlocked, id, ...dataToSave } = container;

            try {
                const containerRef = doc(db, 'artifacts', appId, 'users', userId, 'muDocContainers', id);
                await setDoc(containerRef, dataToSave, { merge: true });
            } catch (e) {
                console.error("Konteyner güncellenirken hata:", e);
                showMessageBox("Hata", "Konum güncellenemedi. Lütfen internet bağlantınızı kontrol edin.");
            }
        }


        // --- Auth & Initialization ---

        function updateAuthUI() {
            const authStatusText = document.getElementById('auth-status-text');
            const userIdDisplay = document.getElementById('user-id-display');

            if (userId) {
                userIdDisplay.textContent = userId;
            } else {
                userIdDisplay.textContent = 'Oturum Yok';
            }

            if (isAnonymous) {
                authStatusText.textContent = 'Anonim (Giriş Yap)';
                authStatusText.classList.remove('text-green-400');
            } else if (userId && auth.currentUser && auth.currentUser.email) {
                authStatusText.textContent = `Giriş Yapıldı (${auth.currentUser.email})`;
                authStatusText.classList.add('text-green-400');
            } else if (userId) {
                authStatusText.textContent = 'Anonim Oturum';
                authStatusText.classList.remove('text-green-400');
            } else {
                 authStatusText.textContent = 'Hesap';
            }
        }

        async function initFirebase() {
            // EK KORUMA: 5 saniye içinde auth değişimi olmazsa yükleme ekranını kapat.
            const loadingTimeout = setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('main-app-content').classList.remove('hidden');
                if (!isAuthReady) {
                    // Yalnızca auth hazır değilse uyarı göster
                    showMessageBox("Kritik Hata (Zaman Aşımı)", "Uygulama 5 saniye içinde başlatılamadı. Bu, eksik veya hatalı Firebase yapılandırmasından ya da ağ sorunlarından kaynaklanabilir. Konsolu kontrol edin.");
                }
            }, 5000); // 5 saniye bekleme

            try {
                // Detaylı konsol çıktısı için debug seviyesini ayarla
                setLogLevel('debug'); 
                
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase yapılandırması eksik. Uygulama başlatılamadı.");
                    // Konfigürasyon yoksa zaman aşımını iptal et ve özel hata mesajını göster.
                    clearTimeout(loadingTimeout);
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('main-app-content').classList.remove('hidden');
                    showMessageBox("Kritik Hata", "Uygulama başlatılamadı: Firebase yapılandırması (API anahtarları vb.) eksik. Uygulamanın çalışması için bu gereklidir.");
                    return; 
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let initialAuthAttempted = false;

                // --- Auth State Listener ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAnonymous = user.isAnonymous;
                        isAuthReady = true;

                        updateAuthUI();
                        setupContainerListener();

                    } else {
                        // No user signed in (e.g., after signOut)
                        userId = null;
                        isAnonymous = false;
                        isAuthReady = true;
                        
                        updateAuthUI();
                        setupContainerListener(); // This will clear the UI

                        // Only attempt initial sign-in if the listener reports no user
                        if (!initialAuthAttempted) {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                try {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } catch (e) {
                                    // If custom token fails, fall back to anonymous
                                    await signInAnonymously(auth);
                                }
                            } else {
                                // Standard anonymous sign-in if no special token
                                await signInAnonymously(auth);
                            }
                        }
                    }
                    
                    // GÜNCELLEME: Yükleme ekranını kimlik doğrulama durumu belirlenir belirlenmez gizle.
                    if (isAuthReady) {
                        clearTimeout(loadingTimeout); // Başarılı olunca zaman aşımını iptal et
                        document.getElementById('loading-overlay').classList.add('hidden');
                        document.getElementById('main-app-content').classList.remove('hidden');
                    }
                });
                
                // --- Initial Auth Check (to kick off the listener if needed) ---
                if (!auth.currentUser) {
                    initialAuthAttempted = true; 
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }

            } catch (e) {
                console.error("Firebase Initialization or Auth Failed (Kritik):", e);
                clearTimeout(loadingTimeout); // Hata yakalanırsa zaman aşımını iptal et
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('main-app-content').classList.remove('hidden');
                showMessageBox("Kritik Hata", "Firebase başlatılırken beklenmedik bir hata oluştu. Lütfen konsolu kontrol edin.");
            }
        }


        // --- Authentication Modal Logic (FIXED: Attached to window) ---

        window.openAuthModal = function() {
            renderAuthContent();
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-modal').classList.add('flex');
        }

        window.closeAuthModal = function() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('auth-modal').classList.remove('flex');
        }

        function renderAuthContent() {
            const contentDiv = document.getElementById('auth-content');
            
            if (auth.currentUser && auth.currentUser.email) {
                // User is signed in with email/password
                contentDiv.innerHTML = `
                    <p class="text-gray-300 mb-4">Şu an kalıcı bir hesapla giriş yapmış durumdasınız.</p>
                    <p class="text-lg font-semibold text-green-400 mb-6">E-posta: ${auth.currentUser.email}</p>
                    <button onclick="handleSignOut()"
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg btn-glow">
                        Çıkış Yap
                    </button>
                `;
            } else if (auth.currentUser && auth.currentUser.isAnonymous) {
                // User is anonymous
                contentDiv.innerHTML = `
                    <p class="text-gray-300 mb-4">Şu an anonim bir oturumdasınız. Verilerinize yalnızca bu cihazdan erişebilirsiniz. Kalıcı bir hesap oluşturmak veya giriş yapmak için aşağıdaki formu kullanın.</p>
                    <hr class="border-gray-700 my-4">

                    <input type="email" id="auth-email" placeholder="E-posta Adresi"
                           class="w-full p-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-orange-500/50 placeholder-gray-500">
                    <input type="password" id="auth-password" placeholder="Şifre (min 6 karakter)"
                           class="w-full p-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-orange-500/50 placeholder-gray-500">
                    
                    <button onclick="handleSignIn()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg btn-glow mb-3">
                        Giriş Yap
                    </button>
                    <button onclick="handleSignUp()"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg btn-glow">
                        Yeni Hesap Oluştur
                    </button>
                `;
            } else {
                 // Fallback if auth state is ambiguous or null (shouldn't happen often)
                contentDiv.innerHTML = `<p class="text-gray-400">Kimlik doğrulama durumu yükleniyor...</p>`;
            }
        }

        window.handleSignUp = async function() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                showMessageBox("Uyarı", "Lütfen e-posta ve şifrenizi girin.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                closeAuthModal();
                showMessageBox("Başarılı", `Hoş geldiniz, ${email}! Hesabınız başarıyla oluşturuldu ve giriş yapıldı. Mevcut anonim oturumunuzdaki verilere artık erişilemiyor.`);
                // The onAuthStateChanged listener handles state change and data loading.
            } catch (error) {
                console.error("Kayıt Hatası:", error);
                let message = "Kayıt olurken bir hata oluştu.";
                if (error.code === 'auth/weak-password') {
                    message = "Şifre 6 karakterden uzun olmalıdır.";
                } else if (error.code === 'auth/email-already-in-use') {
                    message = "Bu e-posta adresi zaten kullanılıyor. Lütfen giriş yapın.";
                } else if (error.code === 'auth/invalid-email') {
                    message = "Geçersiz e-posta formatı.";
                }
                showMessageBox("Hata", message);
            }
        }

        window.handleSignIn = async function() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                showMessageBox("Uyarı", "Lütfen e-posta ve şifrenizi girin.");
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeAuthModal();
                showMessageBox("Başarılı", `Tekrar hoş geldiniz, ${email}! Giriş yapıldı.`);
                // The onAuthStateChanged listener handles state change and data loading.
            } catch (error) {
                console.error("Giriş Hatası:", error);
                let message = "Giriş yapılırken bir hata oluştu.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') {
                    message = "Geçersiz kimlik bilgileri veya kullanıcı bulunamadı.";
                }
                showMessageBox("Hata", message);
            }
        }

        window.handleSignOut = async function() {
            const confirmed = await showConfirmationBox("Çıkış Yap", "Oturumu kapatmak istediğinizden emin misiniz? Anonim oturuma geçilecektir.");
            if (confirmed) {
                try {
                    await signOut(auth);
                    closeAuthModal();
                    showMessageBox("Başarılı", "Başarıyla çıkış yapıldı. Anonim oturuma geçiliyor...");
                    // The onAuthStateChanged listener will automatically re-authenticate as anonymous/default user.
                } catch (error) {
                    console.error("Çıkış Hatası:", error);
                    showMessageBox("Hata", "Çıkış yapılırken bir hata oluştu.");
                }
            }
        }


        // --- Container UI and Actions (Mostly the same, just ensuring calls use isAuthReady) ---

        function renderContainersList() {
            const listContainer = document.getElementById('containers-list');
            listContainer.innerHTML = ''; 

            if (containers.length === 0) {
                listContainer.innerHTML = `
                    <p class="text-center py-4 text-gray-500 text-sm" id="no-containers-message">
                        ${!isAuthReady ? 'Yükleniyor...' : 'Henüz hiç konum oluşturulmadı.'}
                    </p>
                `;
                return;
            }

            containers.forEach(container => {
                const isActive = container.id === activeContainerId;
                const isLocked = container.password && !container.unlocked;

                const itemDiv = document.createElement('div');
                itemDiv.id = `container-${container.id}`;
                itemDiv.className = `container-item p-3 rounded-lg cursor-pointer flex justify-between items-center ${isActive ? 'active' : 'bg-gray-900 hover:bg-gray-700/50'}`;
                itemDiv.onclick = () => selectContainer(container.id, true);
                
                const itemCount = container.content ? container.content.length : 0;
                
                itemDiv.innerHTML = `
                    <span class="flex items-center truncate">
                        ${isLocked ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 1010 0v2h2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2h2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-orange-400" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>'}
                        <span class="truncate">${container.name}</span>
                    </span>
                    <span class="text-xs text-gray-400 ml-2">${itemCount} öğe</span>
                `;

                listContainer.appendChild(itemDiv);
            });
        }
        
        window.createContainer = async function() {
            if (!isAuthReady || !userId) {
                showMessageBox("Uyarı", "Lütfen önce giriş yapın veya oturumun yüklenmesini bekleyin.");
                return;
            }
            
            const nameInput = document.getElementById('new-container-name');
            const passwordInput = document.getElementById('new-container-password');
            const name = nameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!name) {
                showMessageBox("Uyarı", "Lütfen bir konum adı girin.");
                return;
            }

            const newContainerData = {
                name: name,
                password: password,
                content: []
            };

            try {
                const containersCol = getUserContainersCollection();
                if (!containersCol) throw new Error("Koleksiyon referansı alınamadı.");

                const docRef = await addDoc(containersCol, newContainerData);
                showMessageBox("Başarılı", "Yeni konum oluşturuldu.");
                nameInput.value = '';
                passwordInput.value = '';
                
                activeContainerId = docRef.id;

            } catch (e) {
                console.error("Konum oluşturulurken hata:", e);
                showMessageBox("Hata", "Yeni konum oluşturulamadı.");
            }
        }
        
        function selectContainer(id, shouldCheckLock = true) {
            activeContainerId = id;
            const container = getContainerById(id);
            if (!container) return;

            renderContainersList();

            if (container.password && !container.unlocked && shouldCheckLock) {
                showPasswordModal(container.name);
            } else {
                if (container.password && !container.unlocked) {
                    document.getElementById('content-area').innerHTML = document.getElementById('welcome-message').outerHTML;
                } else {
                    renderContainerContent(container);
                }
            }
        }

        window.deleteContainer = async function(id) {
            const confirmed = await showConfirmationBox("Konumu Sil", "Bu konumu ve içindeki TÜM içeriği kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.");

            if (confirmed) {
                try {
                    const containerRef = doc(db, 'artifacts', appId, 'users', userId, 'muDocContainers', id);
                    await deleteDoc(containerRef);
                    activeContainerId = null;
                    document.getElementById('content-area').innerHTML = document.getElementById('welcome-message').outerHTML;
                    showMessageBox("Başarılı", "Konum başarıyla silindi.");
                } catch (e) {
                    console.error("Konum silinirken hata:", e);
                    showMessageBox("Hata", "Konum silinemedi. Silme işlemi sırasında bir veritabanı hatası oluştu.");
                }
            }
        }

        window.unlockContainerAttempt = function() {
            const passwordInput = document.getElementById('password-modal-input').value;
            const container = getContainerById(activeContainerId);

            if (!container) {
                closePasswordModal();
                return;
            }

            if (container.password === passwordInput) {
                container.unlocked = true;
                closePasswordModal();
                renderContainerContent(container);
                renderContainersList(); 
            } else {
                showMessageBox("Hata", "Yanlış şifre! Lütfen tekrar deneyin.");
                document.getElementById('password-modal-input').value = '';
            }
        }
        
        window.showPasswordModal = function(containerName) {
            document.getElementById('password-modal-name').textContent = `Konumu açmak için şifreyi girin: ${containerName}`;
            document.getElementById('password-modal-input').value = '';
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-modal').classList.add('flex');
            document.getElementById('welcome-message').style.display = 'none'; 
            document.getElementById('content-area').innerHTML = ''; 
        }

        window.closePasswordModal = function() {
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('password-modal').classList.remove('flex');
            activeContainerId = null; 
            renderContainersList();
            document.getElementById('content-area').innerHTML = document.getElementById('welcome-message').outerHTML; 
        }

        window.openRenameModal = function(id) {
            const container = getContainerById(id);
            if (!container) return;

            containerToRenameId = id;
            document.getElementById('rename-modal-input').value = container.name;
            document.getElementById('rename-modal').classList.remove('hidden');
            document.getElementById('rename-modal').classList.add('flex');
        }

        window.closeRenameModal = function() {
            document.getElementById('rename-modal').classList.add('hidden');
            document.getElementById('rename-modal').classList.remove('flex');
            containerToRenameId = null;
        }

        window.commitRename = async function() {
            const newName = document.getElementById('rename-modal-input').value.trim();
            const container = getContainerById(containerToRenameId);

            if (!newName) {
                showMessageBox("Uyarı", "Lütfen geçerli bir ad girin.");
                return;
            }

            if (container) {
                container.name = newName;
                await updateContainer(container); // Save to Firestore
                closeRenameModal();
            }
        }

        function renderContainerContent(container) {
            const contentArea = document.getElementById('content-area');

            const headerHtml = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-6 border-orange-500/50">
                    <h2 class="text-4xl font-extrabold text-orange-400 neon-glow mb-2 sm:mb-0 truncate">${container.name}</h2>
                    <div class="flex space-x-3 mt-2 sm:mt-0">
                        <button onclick="openRenameModal('${container.id}')"
                                class="bg-gray-700 hover:bg-gray-600 text-gray-200 py-1 px-3 rounded-md text-sm btn-glow">
                            Ad Değiştir
                        </button>
                        <button onclick="lockContainer('${container.id}')" ${container.password ? '' : 'disabled title="Şifre yok"'}
                                class="bg-blue-700/50 hover:bg-blue-600/70 text-white py-1 px-3 rounded-md text-sm btn-glow disabled:opacity-50 disabled:cursor-not-allowed">
                            Kilitle
                        </button>
                        <button onclick="deleteContainer('${container.id}')"
                                class="bg-red-700/50 hover:bg-red-600/70 text-white py-1 px-3 rounded-md text-sm btn-glow">
                            Konumu Sil
                        </button>
                    </div>
                </div>

                <!-- Add Note/File Forms -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Add Note -->
                    <div class="p-4 bg-gray-900 rounded-lg border border-orange-500/30">
                        <h3 class="text-xl font-bold text-gray-200 mb-3">Yeni Not Ekle</h3>
                        <input type="text" id="note-title" placeholder="Not Başlığı" class="w-full p-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg mb-2 text-sm">
                        <textarea id="note-content" rows="4" placeholder="Not içeriği..." class="w-full p-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg resize-none mb-2 text-sm"></textarea>
                        <button onclick="addNoteToContainer('${container.id}')" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg btn-glow text-sm">
                            Notu Kaydet
                        </button>
                    </div>

                    <!-- Add File/Image -->
                    <div class="p-4 bg-gray-900 rounded-lg border border-orange-500/30">
                        <h3 class="text-xl font-bold text-gray-200 mb-3">Dosya/Fotoğraf Yükle (Max 5MB)</h3>
                        <p class="text-xs text-red-400 mb-3">UYARI: Veriler Base64 olarak DB'ye kaydedilir. Büyük dosyalar performansı düşürür.</p>
                        <input type="file" id="file-input-${container.id}" 
                               class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                        <input type="text" id="file-title-${container.id}" placeholder="Dosya Başlığı" class="w-full p-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg my-2 text-sm">
                        <button onclick="handleFileUpload('${container.id}')" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg btn-glow text-sm mt-2">
                            Yükle ve Kaydet
                        </button>
                    </div>
                </div>

                <h3 class="text-2xl font-bold text-gray-300 mb-4">İçerikler (${container.content.length})</h3>
                <div id="container-content-list" class="space-y-4 min-h-[200px]">
                    <!-- Items list will be injected here -->
                </div>
            `;
            
            contentArea.innerHTML = headerHtml;
            renderContentItems(container);
        }

        window.lockContainer = function(id) {
            const container = getContainerById(id);
            if (container && container.password) {
                container.unlocked = false;
                activeContainerId = null;
                renderContainersList();
                document.getElementById('content-area').innerHTML = document.getElementById('welcome-message').outerHTML;
            } else if (container && !container.password) {
                showMessageBox("Uyarı", "Bu konumda şifre ayarlanmamış. Kilitleme işlemi sadece şifre varsa çalışır.");
            }
        }

        function renderContentItems(container) {
             const list = document.getElementById('container-content-list');
            list.innerHTML = '';

            if (container.content.length === 0) {
                list.innerHTML = `<p class="text-center py-10 text-gray-500">Bu konumda henüz hiç dosya veya not yok.</p>`;
                return;
            }

            container.content.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
                const itemDiv = document.createElement('div');
                let contentHtml = '';
                let icon = '';
                let bgColor = 'bg-gray-900';
                
                if (item.type === 'note') {
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-400 flex-shrink-0 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-4.243 4.243a1 1 0 01-1.414 0l-1.414-1.414a1 1 0 010-1.414L8 10l-.257-1.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>`;
                    contentHtml = `<p class="text-sm text-gray-400 mt-1 whitespace-pre-wrap">${item.data.substring(0, 150)}${item.data.length > 150 ? '...' : ''}</p>`;
                    bgColor = 'bg-gray-900/70';
                } else if (item.type === 'image') {
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 flex-shrink-0 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>`;
                    contentHtml = `<img src="${item.data}" alt="${item.title}" class="max-h-24 w-auto rounded-md mt-2 border border-gray-600"/>`;
                    bgColor = 'bg-gray-900/50';
                } else if (item.type === 'file') {
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400 flex-shrink-0 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7z" /><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                    contentHtml = `<a href="${item.data}" download="${item.title}" class="text-blue-400 hover:text-blue-300 text-sm underline mt-1 block">Dosyayı İndir (${item.mimeType ? item.mimeType.split('/')[1] : 'Bilinmiyor'})</a>`;
                    bgColor = 'bg-gray-900/70';
                }

                itemDiv.className = `p-4 ${bgColor} rounded-lg border border-gray-700 flex justify-between items-start transition duration-150 hover:border-orange-500/50`;
                itemDiv.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <div class="flex items-start">
                            ${icon}
                            <div class="min-w-0">
                                <p class="font-semibold text-lg text-gray-100 truncate">${item.title}</p>
                                <p class="text-xs text-gray-500">${item.date}</p>
                            </div>
                        </div>
                        ${contentHtml}
                    </div>
                    <button onclick="deleteContentItem('${container.id}', '${item.id}')"
                            class="flex-shrink-0 ml-4 bg-red-700/50 hover:bg-red-600/70 text-white p-1 rounded-full btn-glow self-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                `;
                list.appendChild(itemDiv);
            });
        }

        window.addNoteToContainer = async function(containerId) {
            const container = getContainerById(containerId);
            if (!container || !isAuthReady) {
                 showMessageBox("Hata", "Konum yüklenmedi veya kimlik doğrulama tamamlanmadı.");
                return;
            }
            
            const titleInput = document.getElementById('note-title');
            const contentInput = document.getElementById('note-content');
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title || !content) {
                showMessageBox("Uyarı", "Not başlığı ve içeriği boş olamaz.");
                return;
            }

            const newItem = {
                id: generateId(),
                type: 'note',
                title: title,
                data: content,
                date: new Date().toLocaleString('tr-TR')
            };

            container.content.unshift(newItem); 
            await updateContainer(container); 

            titleInput.value = '';
            contentInput.value = '';
            showMessageBox("Başarılı", "Notunuz konuma eklendi.");
        }

        window.handleFileUpload = async function(containerId) {
            const container = getContainerById(containerId);
            if (!container || !isAuthReady) {
                 showMessageBox("Hata", "Konum yüklenmedi veya kimlik doğrulama tamamlanmadı.");
                return;
            }
            
            const fileInput = document.getElementById(`file-input-${containerId}`);
            const titleInput = document.getElementById(`file-title-${containerId}`);
            const file = fileInput.files[0];
            const title = titleInput.value.trim() || file?.name || 'Yüklenen Dosya';

            if (!file) {
                showMessageBox("Uyarı", "Lütfen bir dosya seçin.");
                return;
            }

            const MAX_SIZE_MB = 5;
            if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                 showMessageBox("Hata", `Dosya boyutu ${MAX_SIZE_MB}MB'ı geçemez. Lütfen daha küçük bir dosya kullanın.`);
                return;
            }

            const reader = new FileReader();

            reader.onload = async function(event) {
                const base64Data = event.target.result;
                const fileType = file.type.startsWith('image/') ? 'image' : 'file';

                const newItem = {
                    id: generateId(),
                    type: fileType,
                    title: title,
                    data: base64Data,
                    mimeType: file.type,
                    date: new Date().toLocaleString('tr-TR')
                };

                container.content.unshift(newItem);
                await updateContainer(container);

                fileInput.value = '';
                titleInput.value = '';
                showMessageBox("Başarılı", `${fileType === 'image' ? 'Fotoğrafınız' : 'Dosyanız'} konuma eklendi.`);
            };

            reader.onerror = function(error) {
                console.error("Dosya okuma hatası:", error);
                showMessageBox("Hata", "Dosya yüklenirken bir sorun oluştu.");
            };

            reader.readAsDataURL(file);
        }

        window.deleteContentItem = async function(containerId, itemId) {
            const confirmed = await showConfirmationBox("Öğeyi Sil", "Bu öğeyi kalıcı olarak silmek istediğinizden emin misiniz?");

            if (confirmed) {
                const container = getContainerById(containerId);
                if (container) {
                    container.content = container.content.filter(item => item.id !== itemId);
                    await updateContainer(container);
                    showMessageBox("Başarılı", "Öğe başarıyla silindi.");
                }
            }
        }

        // --- Initialization ---
        window.onload = initFirebase;
    </script>
</body>
</html>
