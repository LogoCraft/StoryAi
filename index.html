<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş PDF Belge Oluşturucu ve Biçimlendirici</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden; /* Sidebar geçişi sırasında yatay kaydırmayı engelle */
        }
        /* Biçimlendirilebilir Alan Stili */
        #editor[contenteditable="true"] {
            min-height: 300px;
            /* Yazıların biçimlendirmesini göstermek için */
            line-height: 1.6;
            font-size: 11pt;
            cursor: text;
        }
        /* Sidebar Stili */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 300px;
            max-width: 80vw; /* Mobil uyumluluk */
            background-color: #1f2937; /* Koyu Gri */
            color: white;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        #sidebar.open {
            transform: translateX(0);
        }
        /* PDF içeriğini yakalamak için gizli div stili (GİZLİ!) */
        #pdf-capture-area {
            position: absolute;
            left: -9999px;
            top: -9999px;
            z-index: -10;
            width: 210mm; /* A4 Genişliği */
            min-height: 297mm; /* A4 Yüksekliği */
            box-sizing: border-box;
            background-color: white;
            padding: 20mm; /* A4 Kenar Boşluğu */
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }
        /* Hamburger butonu konumu */
        #menu-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 60;
        }
    </style>
    <!-- JS PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- HTML2Canvas (PDF'e Biçimlendirilmiş HTML'i aktarmak için) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Crypto JS (Gerekmese de önceki koddan taşındı) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>

<!-- Sol Yukarıdaki Menü Butonu -->
<button id="menu-button" class="p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
</button>

<!-- Yan Gezinme Çubuğu (Sidebar) -->
<div id="sidebar" class="p-4">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-indigo-400">Kaydedilen Belgeler</h2>
        <button id="close-sidebar" class="p-2 text-white hover:text-indigo-400 transition duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    
    <!-- YENİ: Boş Belge Oluştur Butonu -->
    <button id="new-document-button" class="w-full mb-4 py-2 px-4 bg-indigo-500 text-white font-semibold rounded-lg shadow hover:bg-indigo-600 transition duration-200">
        Yeni Boş Belge Oluştur
    </button>

    <ul id="document-list" class="space-y-2">
        <!-- Belgeler buraya dinamik olarak yüklenecek -->
    </ul>
    <p id="no-documents-message" class="text-sm text-gray-400 mt-4">Henüz kaydedilmiş belge yok.</p>
</div>

<div id="app" class="w-full max-w-4xl p-4 md:p-8">
    <header class="text-center mb-6">
        <h1 class="text-3xl font-extrabold text-indigo-700">Biçimlendirilebilir PDF Belge Oluşturucu</h1>
        <p class="text-gray-500 mt-1">Metninizi biçimlendirin, önizleyin ve cihazınıza kaydedin (Sınırsız Metin Alanı).</p>
    </header>

    <!-- Mesaj Kutusu -->
    <div id="message-box" class="hidden p-3 mb-4 text-sm rounded-lg shadow-md transition-all duration-300" role="alert"></div>

    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
        
        <!-- Biçimlendirme Araç Çubuğu -->
        <div id="toolbar" class="flex flex-wrap gap-2 p-3 bg-gray-100 rounded-t-xl border-b border-gray-200">
            <!-- Kalın (Bold) -->
            <button onclick="formatText('bold')" class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-200 font-extrabold text-lg transition duration-150" title="Kalın (Bold)">
                B
            </button>
            <!-- İtalik (Italic) -->
            <button onclick="formatText('italic')" class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-200 italic font-medium text-lg transition duration-150" title="İtalik (Italic)">
                I
            </button>
            <!-- Büyük Başlık (H2) -->
            <button onclick="formatBlock('h2')" class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-200 font-bold text-base transition duration-150" title="Büyük Başlık (H2)">
                Başlık 1
            </button>
             <!-- Küçük Başlık (H3) -->
            <button onclick="formatBlock('h3')" class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-200 font-semibold text-sm transition duration-150" title="Küçük Başlık (H3)">
                Başlık 2
            </button>
            <!-- Paragraf (Normal Metin) -->
            <button onclick="formatBlock('p')" class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-200 text-sm transition duration-150" title="Normal Paragraf Metni">
                Normal
            </button>
            <!-- Numaralı Liste -->
            <button onclick="formatText('insertOrderedList')" class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-200 text-sm transition duration-150" title="Numaralı Liste">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm3 8a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-6 0a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm9 3a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-6 0a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-6 0a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm9-3a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            </button>
            <!-- Madde İşaretli Liste -->
            <button onclick="formatText('insertUnorderedList')" class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-200 text-sm transition duration-150" title="Madde İşaretli Liste">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zm-3-4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm6 0a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-3-4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-3-4a1 1 0 011 1v1a1 1 0 11-2 0V7a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            </button>
            <!-- Yatay Çizgi -->
            <button onclick="formatText('insertHorizontalRule')" class="p-2 bg-white rounded-lg shadow-sm hover:bg-gray-200 text-sm transition duration-150" title="Yatay Çizgi">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>
            </button>
            
            <!-- YENİ: Görselden Metin Çıkarma Butonu -->
            <input type="file" id="image-upload" accept="image/*" class="hidden">
            <button id="extract-text-button" class="p-2 bg-indigo-200 text-indigo-800 rounded-lg shadow-sm hover:bg-indigo-300 font-medium text-sm transition duration-150" title="Görselden Metin Çıkar (YZ)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </button>

            <!-- YENİ: Metin Çıkarma Yükleme İndikatörü -->
            <div id="extraction-loading-indicator" class="hidden flex items-center p-2 text-indigo-700">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Metin Çıkarılıyor...
            </div>
        </div>

        <!-- Metin Düzenleyici Alanı (ContentEditable) -->
        <div id="editor" contenteditable="true" class="w-full p-4 border border-gray-300 rounded-b-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out overflow-y-auto">
            <h2 style="font-size: 1.5em; font-weight: bold;">PDF Belge Başlığı</h2>
            <p>Bu alanda tüm özel karakterler (`i, ğ, ş, ə`) dahil olmak üzere, <b style="font-weight: bold;">sınırsız</b> metin yazabilirsiniz.</p>
            <p>Yazdığınız tüm biçimlendirmeler (Başlıklar, kalın yazılar, listeler, boşluklar) PDF'e birebir yansıtılacaktır.</p>
            <h3 style="font-size: 1.17em; font-weight: bold;">Örnek Liste:</h3>
            <ul>
                <li>iğde</li>
                <li>şeftali</li>
                <li>Əlifba</li>
            </ul>
        </div>
        
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
            <!-- PDF Oluştur, Önizle ve İndir Butonu -->
            <button id="download-pdf" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-indigo-400">
                <span id="download-text">PDF Oluştur, Önizle ve İndir</span>
                <span id="download-loading" class="hidden">PDF Hazırlanıyor... (Önizleme için Bekleyin)</span>
            </button>

            <!-- Yerel Kaydetme Butonu -->
            <button id="save-document" class="flex-1 bg-green-500 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-green-600 transition duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:bg-green-300">
                <span id="save-text">Belgeyi Yerel Olarak Kaydet</span>
                <span id="save-loading" class="hidden">Kaydediliyor...</span>
            </button>
        </div>

        <!-- Yükleme alanı artık sidebar'da listeleniyor, bu alan sadeleştirildi -->
        <p class="text-sm text-gray-500 mt-4 text-center">Kaydettiğiniz belgelere sol yukarıdaki menüden (☰) ulaşabilirsiniz.</p>
        
    </div>
</div>

<!-- GİZLİ PDF İÇERİK YAKALAMA ALANI: Biçimlendirilmiş içeriği A4 boyutunda yakalamak için -->
<div id="pdf-capture-area"></div>


<script>
    // DEPOLAMA ANAHTARI (localStorage)
    const DOCUMENTS_KEY = 'pdf_documents_list';
    
    // Gemini API yapılandırması
    const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
    const apiKey = "AIzaSyC5TjJMwl_kjTF9unQbpik5exA8WDn0_Bk";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

    // UI Elementleri
    const editor = document.getElementById('editor');
    const downloadPdfButton = document.getElementById('download-pdf');
    const saveDocumentButton = document.getElementById('save-document');
    const messageBox = document.getElementById('message-box');
    const pdfCaptureArea = document.getElementById('pdf-capture-area');
    const sidebar = document.getElementById('sidebar');
    const menuButton = document.getElementById('menu-button');
    const closeSidebarButton = document.getElementById('close-sidebar');
    const documentList = document.getElementById('document-list');
    const noDocumentsMessage = document.getElementById('no-documents-message');
    const newDocumentButton = document.getElementById('new-document-button'); 
    const imageUploadInput = document.getElementById('image-upload'); // Yeni input
    const extractTextButton = document.getElementById('extract-text-button'); // Yeni buton
    const extractionLoadingIndicator = document.getElementById('extraction-loading-indicator');

    // Varsayılan boş belge içeriği (Yeni belge oluşturulurken kullanılır)
    const DEFAULT_CONTENT = `
        <h2 style="font-size: 1.5em; font-weight: bold;">Yeni Boş Belge</h2>
        <p>Çalışmaya başlamak için buraya metin yazın.</p>
    `;
    
    // --- EDİTÖR FONKSİYONLARI ---

    // Kalın, italik, liste vb. temel komutları uygular
    window.formatText = function(command) {
        document.execCommand(command, false, null);
        editor.focus();
    }

    // Başlık (H2, H3, P) gibi blok formatlarını uygular
    window.formatBlock = function(tag) {
        document.execCommand('formatBlock', false, tag);
        editor.focus();
    }

    // Editörü temizler ve varsayılan boş içeriği yükler
    window.createNewDocument = function() {
        if (editor.innerHTML.trim() !== DEFAULT_CONTENT.trim() && editor.innerHTML.trim() !== '') {
            // confirm() yerine custom modal kullanılması gerektiği için, basit bir onay mesajı veriyoruz.
            if (!confirm('Kaydedilmemiş değişiklikleriniz kaybolacak. Yeni bir boş belge açmak istediğinizden emin misiniz?')) {
                return;
            }
        }
        editor.innerHTML = DEFAULT_CONTENT;
        showMessage('Yeni boş belge oluşturuldu.', 'info');
        sidebar.classList.remove('open');
        editor.focus();
    }

    // --- YEREL DEPOLAMA (localStorage) FONKSİYONLARI ---

    // Yerel depolamadan tüm belgeleri yükler
    function loadLocalDocuments() {
        try {
            const data = localStorage.getItem(DOCUMENTS_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Yerel belgeler yüklenemedi:", e);
            return [];
        }
    }

    // Belgeleri yerel depolamaya kaydeder
    function saveLocalDocuments(documents) {
        try {
            localStorage.setItem(DOCUMENTS_KEY, JSON.stringify(documents));
        } catch (e) {
            console.error("Yerel belgeler kaydedilemedi:", e);
            showMessage("Kaydetme işlemi başarısız oldu. Tarayıcınızın depolama alanı dolmuş olabilir.", 'error');
        }
    }
    
    // Metni Yerel Olarak Kaydet
    function saveDocument() {
        const contentHtml = editor.innerHTML.trim();
        if (!contentHtml || contentHtml === DEFAULT_CONTENT.trim()) {
            showMessage("Lütfen kaydetmek için içerik girin veya mevcut içeriği değiştirin.", 'warning');
            return;
        }

        document.getElementById('save-text').classList.add('hidden');
        document.getElementById('save-loading').classList.remove('hidden');
        saveDocumentButton.disabled = true;

        try {
            const documents = loadLocalDocuments();
            // Basit bir başlık oluştur
            const titleMatch = contentHtml.match(/<h[1-6].*?>(.*?)<\/h[1-6]>|<p>(.{1,30})<\/p>/i);
            const defaultTitle = new Date().toLocaleString('tr-TR', { dateStyle: 'short', timeStyle: 'short' });
            let title = defaultTitle;

            if (titleMatch) {
                // HTML etiketlerini temizle
                title = titleMatch[1] || titleMatch[2];
                title = title.replace(/<[^>]*>?/gm, '').trim() || defaultTitle;
                // Başlık 50 karakterden uzunsa kısalt
                if (title.length > 50) {
                    title = title.substring(0, 50) + '...';
                }
            }

            const docId = 'DOC-' + Date.now(); 

            const newDocument = {
                id: docId,
                title: title,
                content: contentHtml, 
                createdAt: new Date().toISOString()
            };

            documents.unshift(newDocument); // Yeni belgeyi listenin başına ekle
            saveLocalDocuments(documents);
            renderSidebar(); // Sidebar'ı güncelle
            
            showMessage(`Belge ("${title}") yerel olarak kaydedildi!`, 'success');
        } catch (error) {
            console.error("Yerel kaydetme hatası:", error);
            showMessage("Belge kaydedilirken bir hata oluştu: " + error.message, 'error');
        } finally {
            document.getElementById('save-text').classList.remove('hidden');
            document.getElementById('save-loading').classList.add('hidden');
            saveDocumentButton.disabled = false;
        }
    }
    
    // Sidebar'daki bir belgeyi editöre yükler
    function loadDocumentById(docId) {
        const documents = loadLocalDocuments();
        const document = documents.find(doc => doc.id === docId);

        if (document) {
            editor.innerHTML = document.content;
            showMessage(`Belge ("${document.title}") yüklendi.`, 'success');
            sidebar.classList.remove('open'); // Yüklendikten sonra sidebar'ı kapat
        } else {
            showMessage("Bu kimliğe ait bir belge bulunamadı.", 'error');
        }
    }
    
    // Sidebar'daki bir belgeyi siler
    function deleteDocument(docId) {
        let documents = loadLocalDocuments();
        const initialLength = documents.length;
        
        // Silme işlemi
        documents = documents.filter(doc => doc.id !== docId);
        
        if (documents.length < initialLength) {
            saveLocalDocuments(documents);
            renderSidebar();
            showMessage("Belge başarıyla silindi.", 'success');
        } else {
             showMessage("Belge bulunamadı veya silinemedi.", 'error');
        }
    }

    // --- SİDEBAR FONKSİYONLARI ---

    // Sidebar'ı dinamik olarak oluşturur
    function renderSidebar() {
        const documents = loadLocalDocuments();
        documentList.innerHTML = ''; 

        if (documents.length === 0) {
            noDocumentsMessage.classList.remove('hidden');
            return;
        }

        noDocumentsMessage.classList.add('hidden');

        documents.forEach(doc => {
            const li = document.createElement('li');
            li.className = "flex justify-between items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition cursor-pointer";
            
            const titleSpan = document.createElement('span');
            titleSpan.className = "text-sm text-white truncate flex-1 pr-2";
            titleSpan.textContent = doc.title;
            titleSpan.onclick = () => loadDocumentById(doc.id);

            // Silme butonu
            const deleteButton = document.createElement('button');
            // confirm() yerine custom modal kullanılması gerektiği için, burada da basit bir onay mesajı veriyoruz.
            deleteButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-400 hover:text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3" /></svg>';
            deleteButton.className = "ml-2 p-1 rounded hover:bg-gray-500";
            deleteButton.title = "Sil";
            deleteButton.onclick = (e) => {
                e.stopPropagation(); // li tıklamasını engelle
                if (confirm('Bu belgeyi yerel depolamadan kalıcı olarak silmek istediğinizden emin misiniz?')) {
                    deleteDocument(doc.id);
                }
            };

            li.appendChild(titleSpan);
            li.appendChild(deleteButton);
            documentList.appendChild(li);
        });
    }

    // Sidebar'ı açıp kapatır
    function toggleSidebar() {
        sidebar.classList.toggle('open');
        // Sidebar açıldığında menüden silme/yükleme yapabilmek için listeyi yenile
        if (sidebar.classList.contains('open')) {
            renderSidebar();
        }
    }
    
    // --- GENEL UI FONKSİYONLARI ---

    // Mesaj Kutusu Yönetimi
    function showMessage(text, type = 'info') {
        let classes = 'text-gray-900 bg-gray-100 border-gray-300';
        if (type === 'success') {
            classes = 'text-green-800 bg-green-100 border-green-300';
        } else if (type === 'error') {
            classes = 'text-red-800 bg-red-100 border-red-300';
        } else if (type === 'warning') {
            classes = 'text-yellow-800 bg-yellow-100 border-yellow-300';
        }
        
        messageBox.className = `p-3 mb-4 text-sm rounded-lg shadow-md transition-all duration-300 border ${classes}`;
        messageBox.innerHTML = text;
        messageBox.classList.remove('hidden');

        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, 5000);
    }

    // --- GEMINI API FONKSİYONLARI ---

    // Dosyayı Base64 string'e dönüştürür (veri tipi dahil: "data:image/jpeg;base64,...")
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            if (!file) {
                return reject(new Error("Dosya yok."));
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    // API çağrısını üstel geri çekilme ile yapar
    async function callApiWithBackoff(url, payload, maxRetries = 5) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 || response.status >= 500) {
                    // 429 Too Many Requests veya 5xx sunucu hataları için tekrar dene
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Tekrar dene
                    }
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API hatası: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                return await response.json();

            } catch (error) {
                if (i === maxRetries - 1) {
                    throw error; // Maksimum denemeden sonra hatayı fırlat
                }
            }
        }
    }
    
    // Görselden metni çıkarır ve editöre ekler
    async function processImage(file) {
        if (!file) return;

        extractionLoadingIndicator.classList.remove('hidden');
        extractTextButton.disabled = true;

        try {
            // 1. Base64'e dönüştür
            const base64DataUrl = await fileToBase64(file);
            const [mimeType, base64Data] = base64DataUrl.split(',');

            if (!base64Data) {
                 throw new Error("Base64 veri ayrıştırılamadı.");
            }
            
            // 2. API Payload oluştur
            const userPrompt = "Bu görseldeki tüm metni çıkar ve biçimlendirilmiş metin (örneğin paragraflar, liste maddeleri) olarak geri döndür. Türkçe karakterlere ve noktalama işaretlerine dikkat et. Herhangi bir açıklayıcı cümle, başlık veya YZ mesajı ekleme. Sadece çıkarılan metni döndür.";
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userPrompt },
                        {
                            inlineData: {
                                mimeType: mimeType.split(':')[1].split(';')[0], // 'image/png'
                                data: base64Data 
                            }
                        }
                    ]
                }],
            };

            // 3. API'yi çağır (Üstel geri çekilme ile)
            const result = await callApiWithBackoff(apiUrl, payload);
            
            const extractedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (extractedText) {
                // 4. Metni editöre ekle
                // Metni bir <p> etiketi içine sararak veya olduğu gibi ekleyerek editöre ekleyebiliriz.
                // Markdown/Text döndürdüğü için yeni bir div oluşturup innerHTML olarak eklemek,
                // biçimlendirmeyi (paragraf, liste) korumada yardımcı olabilir.
                
                // Metni eklemeden önce, satır sonlarını <br> veya yeni paragraflara dönüştürerek
                // düzenlenebilir div'e uygun hale getirelim.
                const formattedText = extractedText
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .join('<br>'); // Basitçe satır sonlarını koru
                
                editor.innerHTML += `<hr style="margin-top: 15px; margin-bottom: 15px;"><h4>Görselden Çıkarılan Metin:</h4>` + formattedText;
                
                showMessage(`Görseldeki metin (${file.name}) başarıyla çıkarıldı ve editöre eklendi.`, 'success');
                editor.focus();
            } else {
                showMessage("YZ görselden metin çıkaramadı. Lütfen daha net bir görsel deneyin.", 'warning');
            }

        } catch (error) {
            console.error("Metin Çıkarma Hatası:", error);
            showMessage("Metin çıkarma işleminde kritik bir hata oluştu: " + error.message, 'error');
        } finally {
            extractionLoadingIndicator.classList.add('hidden');
            extractTextButton.disabled = false;
            // Dosya seçim alanını temizle
            imageUploadInput.value = '';
        }
    }
    
    // --- PDF FONKSİYONU ---

    // Metni PDF'e dönüştürme (html2canvas ile)
    function generatePDF() {
        const contentHtml = editor.innerHTML.trim();
        if (!contentHtml) {
            showMessage("Lütfen PDF oluşturmak için içerik girin.", 'warning');
            return;
        }

        document.getElementById('download-text').classList.add('hidden');
        document.getElementById('download-loading').classList.remove('hidden');
        downloadPdfButton.disabled = true;

        try {
            // Biçimlendirilmiş HTML içeriğini gizli yakalama alanına yerleştir
            pdfCaptureArea.innerHTML = contentHtml;

            // PDF ayarları
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); 
            const source = pdfCaptureArea;
            
            // html2canvas ile DOM elementini tuvale (canvas) dönüştür
            window.html2canvas(source, {
                scale: 2, // Yüksek çözünürlük için
                useCORS: true,
                logging: false,
                // letterRendering: true kaldırıldı
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                
                const pdfWidthMM = 170; // PDF içeriği genişliği (A4 - 2 * 20mm margin)
                const margin = 20; // 20mm kenar boşluğu
                
                const imgWidth = pdfWidthMM;
                const pageHeight = doc.internal.pageSize.getHeight(); // A4 yüksekliği (297mm)
                const imgHeight = canvas.height * imgWidth / canvas.width; // Toplam resim yüksekliği (mm)
                const contentHeight = pageHeight - (2 * margin); // Bir sayfadaki kullanılabilir içerik yüksekliği (257mm)
                
                let heightLeft = imgHeight;
                let positionY = 0; // PDF sayfası üzerinde görüntünün başlayacağı Y pozisyonu (kaydırmayı simüle etmek için negatif olacak)

                // İlk sayfayı ekle
                // Görüntünün tamamını ekle, ancak sadece sayfa boyutunda görünen kısmını PDF'e sığdır.
                doc.addImage(imgData, 'PNG', margin, margin + positionY, imgWidth, imgHeight);
                
                // Kalan yükseklikten ilk sayfanın içerik alanını düş
                heightLeft -= contentHeight; 

                // Çok sayfalı döngü
                while (heightLeft > 0) {
                    // Pozisyonu bir sayfa içeriği yüksekliği kadar yukarı kaydır
                    positionY -= contentHeight; 
                    doc.addPage();
                    
                    // Görüntünün tamamını, yeni kaydırılmış pozisyonda ekle
                    // (margin + positionY) kısmı, görüntünün üst kenarını yukarı taşıyarak
                    // bir sonraki sayfa bölümünün görünmesini sağlar.
                    doc.addImage(imgData, 'PNG', margin, margin + positionY, imgWidth, imgHeight);
                    
                    heightLeft -= contentHeight;
                }
                
                // Önizleme ve İndirme
                doc.save("Belgem_Bicimli_Onizle.pdf");
                showMessage("PDF başarıyla oluşturuldu. Tarayıcınız önizleme penceresini açacaktır.", 'success');

                // Temizleme
                pdfCaptureArea.innerHTML = '';
            }).catch(e => {
                console.error("PDF oluşturma/html2canvas hatası:", e);
                showMessage("PDF oluşturulurken bir hata oluştu. Biçimlendirmeyi sadeleştirmeyi deneyin (hata: Incomplete or corrupt PNG file).", 'error');
            }).finally(() => {
                // UI durumu geri yükle
                document.getElementById('download-text').classList.remove('hidden');
                document.getElementById('download-loading').classList.add('hidden');
                downloadPdfButton.disabled = false;
            });

        } catch (e) {
            console.error("PDF oluşturma hatası:", e);
            showMessage("PDF oluşturulurken beklenmedik bir hata oluştu.", 'error');
            document.getElementById('download-text').classList.remove('hidden');
            document.getElementById('download-loading').classList.add('hidden');
            downloadPdfButton.disabled = false;
        }
    }


    // --- EVENT LISTENERS ---
    
    // Yükleme sırasında varsayılan içeriği editöre yükle
    window.onload = function() {
        renderSidebar(); // Başlangıçta sidebar'ı doldur
        editor.innerHTML = DEFAULT_CONTENT; // Uygulama ilk açıldığında varsayılan içeriği yükle
    };

    // Görsel Yükleme Butonu Tıklaması
    extractTextButton.addEventListener('click', () => {
        imageUploadInput.click();
    });

    // Görsel Seçildikten Sonra
    imageUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            processImage(file);
        }
    });

    menuButton.addEventListener('click', toggleSidebar);
    closeSidebarButton.addEventListener('click', toggleSidebar);
    downloadPdfButton.addEventListener('click', generatePDF);
    saveDocumentButton.addEventListener('click', saveDocument);
    newDocumentButton.addEventListener('click', createNewDocument);
</script
